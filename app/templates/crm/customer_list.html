{% extends "base.html" %}

{% block title %}客户管理 - CRM系统{% endblock %}
{% block meta_description %}个人门户网站CRM客户关系管理系统，客户信息管理和商机跟踪。{% endblock %}

{% block extra_css %}
<style>
.crm-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem 1rem 0 0;
    padding: 2rem;
    margin: -1rem -1rem 1rem -1rem;
}

.customer-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
    position: relative;
}

.customer-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.customer-card.high-value {
    border-left: 4px solid var(--bs-success);
}

.customer-card.medium-value {
    border-left: 4px solid var(--bs-warning);
}

.customer-card.low-value {
    border-left: 4px solid var(--bs-secondary);
}

.lead-score {
    position: absolute;
    top: 1rem;
    right: 1rem;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

.lead-score.high {
    background-color: var(--bs-success);
}

.lead-score.medium {
    background-color: var(--bs-warning);
}

.lead-score.low {
    background-color: var(--bs-secondary);
}

.customer-meta {
    font-size: 0.875rem;
    color: var(--bs-secondary);
}

.customer-type-badge {
    padding: 0.35em 0.8em;
    border-radius: 2rem;
    font-weight: 500;
    font-size: 0.75rem;
}

.stats-grid {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-bar {
    background-color: var(--bs-light);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.customer-actions .btn {
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    margin: 0 0.1rem;
}

.follow-up-indicator {
    background-color: var(--bs-danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    position: absolute;
    top: -8px;
    right: -8px;
}

/* Dark theme adjustments */
[data-bs-theme="dark"] .customer-card {
    background-color: var(--bs-dark);
    border-color: var(--bs-gray-700);
}

[data-bs-theme="dark"] .filter-bar {
    background-color: var(--bs-gray-800);
}

[data-bs-theme="dark"] .stats-grid {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
}

@media (max-width: 768px) {
    .customer-card .row {
        --bs-gutter-x: 1rem;
    }
    
    .lead-score {
        position: static;
        margin-bottom: 0.5rem;
    }
    
    .customer-actions {
        text-align: center;
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card">
        <div class="crm-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">客户管理</h1>
                    <p class="mb-0 opacity-90">CRM客户关系管理系统</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light" id="refreshCustomers">
                        <i class="fas fa-sync-alt me-2"></i>刷新
                    </button>
                    <button class="btn btn-outline-light" onclick="syncInquiriesToCustomers()">
                        <i class="fas fa-user-plus me-2"></i>同步咨询
                    </button>
                    <button class="btn btn-outline-light" onclick="exportCustomers()">
                        <i class="fas fa-download me-2"></i>导出
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body">
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="row text-center">
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-primary">{{ stats.total_customers or 0 }}</div>
                            <small class="text-muted">总客户数</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-success">{{ stats.signed_customers or 0 }}</div>
                            <small class="text-muted">签约客户</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-warning">{{ stats.potential_customers or 0 }}</div>
                            <small class="text-muted">潜在客户</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-info">{{ stats.active_customers or 0 }}</div>
                            <small class="text-muted">活跃客户</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-danger">{{ stats.pending_followups or 0 }}</div>
                            <small class="text-muted">需要跟进</small>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div>
                            <div class="h4 mb-1 text-secondary">
                                {{ ((stats.signed_customers or 0) / (stats.total_customers or 1) * 100) | round(1) }}%
                            </div>
                            <small class="text-muted">转化率</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <form method="GET" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" name="search" 
                                   placeholder="搜索客户姓名、邮箱或公司..." 
                                   value="{{ current_search }}">
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <select class="form-select" name="type">
                            <option value="">所有类型</option>
                            <option value="潜在客户" {{ 'selected' if current_type == '潜在客户' }}>潜在客户</option>
                            <option value="意向客户" {{ 'selected' if current_type == '意向客户' }}>意向客户</option>
                            <option value="签约客户" {{ 'selected' if current_type == '签约客户' }}>签约客户</option>
                            <option value="流失客户" {{ 'selected' if current_type == '流失客户' }}>流失客户</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <select class="form-select" name="value">
                            <option value="">所有价值</option>
                            <option value="高" {{ 'selected' if current_value == '高' }}>高价值</option>
                            <option value="中" {{ 'selected' if current_value == '中' }}>中价值</option>
                            <option value="低" {{ 'selected' if current_value == '低' }}>低价值</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <select class="form-select" name="sort">
                            <option value="updated_desc" {{ 'selected' if current_sort == 'updated_desc' }}>最近更新</option>
                            <option value="created_desc" {{ 'selected' if current_sort == 'created_desc' }}>最新创建</option>
                            <option value="name_asc" {{ 'selected' if current_sort == 'name_asc' }}>姓名排序</option>
                            <option value="lead_score_desc" {{ 'selected' if current_sort == 'lead_score_desc' }}>线索评分</option>
                            <option value="last_contact_desc" {{ 'selected' if current_sort == 'last_contact_desc' }}>最后接触</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="d-flex gap-1">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            <a href="{{ url_for('crm.customer_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                            <a href="{{ url_for('crm.crm_dashboard') }}" class="btn btn-outline-info">
                                <i class="fas fa-chart-line"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Customer List -->
            {% if customers %}
            <div class="customers-list">
                {% for customer in customers %}
                <div class="customer-card {{ customer.value_level.lower() }}-value">
                    <!-- Lead Score Badge -->
                    <div class="lead-score {{ 'high' if customer.lead_score >= 70 else 'medium' if customer.lead_score >= 40 else 'low' }}">
                        {{ customer.lead_score }}
                    </div>

                    <!-- Follow-up Indicator -->
                    {% if customer.needs_followup() %}
                    <div class="follow-up-indicator" title="需要跟进">
                        !
                    </div>
                    {% endif %}

                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- Customer Header -->
                                <div class="d-flex align-items-start justify-content-between mb-3">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-2">
                                            <a href="{{ url_for('crm.customer_detail', id=customer.id) }}" 
                                               class="text-decoration-none">
                                                {{ customer.name }}
                                            </a>
                                            {% if customer.customer_code %}
                                            <small class="text-muted">({{ customer.customer_code }})</small>
                                            {% endif %}
                                        </h5>
                                        
                                        <div class="customer-meta d-flex flex-wrap gap-3 mb-2">
                                            <span>
                                                <i class="fas fa-envelope me-1"></i>{{ customer.email }}
                                            </span>
                                            {% if customer.phone %}
                                            <span>
                                                <i class="fas fa-phone me-1"></i>{{ customer.phone }}
                                            </span>
                                            {% endif %}
                                            {% if customer.company %}
                                            <span>
                                                <i class="fas fa-building me-1"></i>{{ customer.company }}
                                            </span>
                                            {% endif %}
                                            {% if customer.title %}
                                            <span>
                                                <i class="fas fa-user-tie me-1"></i>{{ customer.title }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex flex-wrap gap-2 mb-3">
                                            <span class="customer-type-badge bg-{{ 'success' if customer.customer_type == '签约客户' else 'warning' if customer.customer_type == '意向客户' else 'info' if customer.customer_type == '潜在客户' else 'secondary' }}">
                                                {{ customer.customer_type }}
                                            </span>
                                            <span class="customer-type-badge bg-light text-dark">
                                                <i class="fas fa-star me-1"></i>{{ customer.value_level }}价值
                                            </span>
                                            {% if customer.lead_source %}
                                            <span class="customer-type-badge bg-light text-dark">
                                                <i class="fas fa-source me-1"></i>{{ customer.lead_source }}
                                            </span>
                                            {% endif %}
                                            {% if customer.conversion_probability %}
                                            <span class="customer-type-badge bg-light text-dark">
                                                <i class="fas fa-percentage me-1"></i>{{ (customer.conversion_probability * 100) | round(0) }}%转化
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Summary -->
                                {% if customer.notes %}
                                <div class="customer-notes mb-3">
                                    <p class="card-text">{{ customer.notes | truncate(150) }}</p>
                                </div>
                                {% endif %}

                                <!-- Contact Information -->
                                <div class="contact-info">
                                    <div class="row g-2">
                                        {% if customer.inquiries.count() > 0 %}
                                        <div class="col-md-6">
                                            <small class="text-muted">咨询数量：</small>
                                            <strong>{{ customer.inquiries.count() }}</strong>
                                        </div>
                                        {% endif %}
                                        {% if customer.last_contact %}
                                        <div class="col-md-6">
                                            <small class="text-muted">最后接触：</small>
                                            <strong>{{ customer.days_since_last_contact() }}天前</strong>
                                        </div>
                                        {% endif %}
                                        {% if customer.next_followup %}
                                        <div class="col-md-6">
                                            <small class="text-muted">下次跟进：</small>
                                            <strong class="{{ 'text-danger' if customer.needs_followup() else 'text-success' }}">
                                                {{ customer.next_followup.strftime('%m月%d日') }}
                                            </strong>
                                        </div>
                                        {% endif %}
                                        {% if customer.opportunities.count() > 0 %}
                                        <div class="col-md-6">
                                            <small class="text-muted">商机数量：</small>
                                            <strong>{{ customer.opportunities.count() }}</strong>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Tags -->
                                {% if customer.get_tags_list() %}
                                <div class="customer-tags mt-3">
                                    {% for tag in customer.get_tags_list() %}
                                    <span class="badge bg-light text-primary me-1 mb-1">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-lg-4">
                                <!-- Conversion Probability -->
                                {% if customer.conversion_probability %}
                                <div class="text-center mb-3">
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-{{ 'success' if customer.conversion_probability > 0.7 else 'warning' if customer.conversion_probability > 0.4 else 'info' }}" 
                                             style="width: {{ (customer.conversion_probability * 100) | round(0) }}%"></div>
                                    </div>
                                    <small class="text-muted">转化概率 {{ (customer.conversion_probability * 100) | round(0) }}%</small>
                                </div>
                                {% endif %}

                                <!-- Action Buttons -->
                                <div class="customer-actions d-grid gap-2">
                                    <a href="{{ url_for('crm.customer_detail', id=customer.id) }}" 
                                       class="btn btn-primary">
                                        <i class="fas fa-eye me-2"></i>查看详情
                                    </a>
                                    
                                    <a href="{{ url_for('crm.customer_edit', id=customer.id) }}" 
                                       class="btn btn-outline-success">
                                        <i class="fas fa-edit me-2"></i>编辑信息
                                    </a>
                                    
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-cog"></i> 更多操作
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="addInteraction({{ customer.id }})">
                                                <i class="fas fa-comment me-2"></i>添加互动
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="scheduleFollowup({{ customer.id }})">
                                                <i class="fas fa-calendar-plus me-2"></i>安排跟进
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="{{ url_for('crm.opportunity_edit') }}?customer_id={{ customer.id }}">
                                                <i class="fas fa-plus me-2"></i>创建商机
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateLeadScore({{ customer.id }})">
                                                <i class="fas fa-chart-line me-2"></i>更新评分
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if pagination and pagination.pages > 1 %}
            <nav aria-label="客户分页" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('crm.customer_list', page=pagination.prev_num, search=current_search, type=current_type, value=current_value, sort=current_sort) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('crm.customer_list', page=page_num, search=current_search, type=current_type, value=current_value, sort=current_sort) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('crm.customer_list', page=pagination.next_num, search=current_search, type=current_type, value=current_value, sort=current_sort) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="fas fa-users fa-4x text-muted mb-4"></i>
                <h4 class="text-muted">
                    {% if current_search or current_type or current_value %}
                    没有找到符合条件的客户
                    {% else %}
                    还没有任何客户记录
                    {% endif %}
                </h4>
                <p class="text-muted mb-4">
                    {% if current_search or current_type or current_value %}
                    尝试调整搜索条件或筛选器
                    {% else %}
                    客户记录将从咨询记录自动同步创建
                    {% endif %}
                </p>
                
                {% if current_search or current_type or current_value %}
                <a href="{{ url_for('crm.customer_list') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-times me-2"></i>清除筛选
                </a>
                {% endif %}
                
                <button class="btn btn-primary" onclick="syncInquiriesToCustomers()">
                    <i class="fas fa-sync-alt me-2"></i>同步咨询记录
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Interaction Modal -->
<div class="modal fade" id="interactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加客户互动</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="interactionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">互动类型</label>
                        <select class="form-select" name="interaction_type" required>
                            <option value="电话">电话沟通</option>
                            <option value="邮件">邮件联系</option>
                            <option value="会议">会议讨论</option>
                            <option value="访问">现场访问</option>
                            <option value="微信">微信沟通</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">互动内容</label>
                        <textarea class="form-control" name="content" rows="4" required
                                  placeholder="详细描述本次互动的内容..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">互动结果</label>
                        <textarea class="form-control" name="outcome" rows="2"
                                  placeholder="互动的结果和后续行动计划..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">持续时长(分钟)</label>
                        <input type="number" class="form-control" name="duration" min="1" max="480">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存互动记录</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Follow-up Modal -->
<div class="modal fade" id="followupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">安排客户跟进</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="followupForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">跟进时间</label>
                        <select class="form-select" name="days_ahead" required>
                            <option value="1">明天</option>
                            <option value="3">3天后</option>
                            <option value="7" selected>1周后</option>
                            <option value="14">2周后</option>
                            <option value="30">1个月后</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">跟进备注</label>
                        <textarea class="form-control" name="note" rows="3"
                                  placeholder="跟进的具体事项和目标..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">安排跟进</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentCustomerId = null;

// Add interaction
function addInteraction(customerId) {
    currentCustomerId = customerId;
    const modal = new bootstrap.Modal(document.getElementById('interactionModal'));
    modal.show();
}

// Schedule followup
function scheduleFollowup(customerId) {
    currentCustomerId = customerId;
    const modal = new bootstrap.Modal(document.getElementById('followupModal'));
    modal.show();
}

// Handle interaction form submission
document.getElementById('interactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    fetch(`/crm/customer/${currentCustomerId}/interaction`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('interactionModal')).hide();
            location.reload();
        } else {
            alert('操作失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败，请稍后重试');
    });
});

// Handle followup form submission
document.getElementById('followupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    fetch(`/crm/customer/${currentCustomerId}/followup`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('followupModal')).hide();
            location.reload();
        } else {
            alert('操作失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败，请稍后重试');
    });
});

// Update lead score
function updateLeadScore(customerId) {
    if (confirm('确定要重新计算客户线索评分吗？')) {
        fetch(`/crm/api/customer/${customerId}/lead_score`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('更新失败：' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('更新失败，请稍后重试');
        });
    }
}

// Sync inquiries to customers
function syncInquiriesToCustomers() {
    if (confirm('确定要将咨询记录同步为客户记录吗？这将为所有没有对应客户记录的咨询创建新的客户档案。')) {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>同步中...';
        btn.disabled = true;
        
        fetch('/crm/sync/inquiries-to-customers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('同步失败：' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('同步失败，请稍后重试');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
}

// Export customers
function exportCustomers() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'true');
    window.open(`/crm/customers/export?${params.toString()}`, '_blank');
}

// Refresh customers
document.getElementById('refreshCustomers').addEventListener('click', function() {
    const btn = this;
    const icon = btn.querySelector('i');
    
    icon.classList.add('fa-spin');
    btn.disabled = true;
    
    setTimeout(() => {
        location.reload();
    }, 500);
});

// Auto-submit filter form on select changes
document.querySelectorAll('#filterForm select').forEach(select => {
    select.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});

// Real-time search with debounce
let searchTimeout;
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length >= 2 || this.value.length === 0) {
                document.getElementById('filterForm').submit();
            }
        }, 500);
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K for search focus
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
    }
    
    // Ctrl/Cmd + R for refresh
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        location.reload();
    }
});
</script>
{% endblock %}