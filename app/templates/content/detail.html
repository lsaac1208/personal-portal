{% extends "base.html" %}

{% block title %}{{ content.title }} - 个人门户网站{% endblock %}
{% block meta_description %}{{ content.summary or (content.content | striptags | truncate(160)) }}{% endblock %}
{% block meta_keywords %}{{ content.tags or '' }},{{ content.category }},技术博客,{{ content.title }}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ content.title }}{% endblock %}
{% block og_description %}{{ content.summary or (content.content | striptags | truncate(200)) }}{% endblock %}
{% block og_image %}
{% if content.featured_image %}
{{ url_for('static', filename='uploads/' + content.featured_image, _external=True) }}
{% else %}
{{ super() }}
{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="bg-light py-3">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.index') }}" class="text-decoration-none">
                    <i class="fas fa-home"></i> 首页
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('content.all_content') }}" class="text-decoration-none">内容</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('content.category_list', category=content.category) }}" class="text-decoration-none">
                    {{ get_category_emoji(content.category) }} {{ content.category }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ content.title | truncate(50) }}
            </li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<article class="container py-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Article Header -->
            <header class="mb-5">
                <!-- Category Badge -->
                <div class="mb-3">
                    <span class="badge bg-primary fs-6">
                        {{ get_category_emoji(content.category) }} {{ content.category }}
                    </span>
                    {% if content.is_featured %}
                    <span class="badge bg-warning text-dark fs-6 ms-2">
                        <i class="fas fa-star"></i> 精选推荐
                    </span>
                    {% endif %}
                </div>
                
                <!-- Title -->
                <h1 class="display-5 fw-bold text-dark mb-4">
                    {{ content.title }}
                </h1>
                
                <!-- Summary -->
                {% if content.summary %}
                <p class="lead text-muted mb-4">
                    {{ content.summary }}
                </p>
                {% endif %}
                
                <!-- Meta Information -->
                <div class="article-meta d-flex flex-wrap align-items-center gap-3 mb-4 pb-4 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-alt text-muted me-2"></i>
                        <span class="text-muted">
                            发布于 <time datetime="{{ content.created_at.isoformat() }}">
                                {{ moment(content.created_at).format('YYYY年MM月DD日') }}
                            </time>
                        </span>
                    </div>
                    
                    {% if content.updated_at != content.created_at %}
                    <div class="d-flex align-items-center">
                        <i class="fas fa-edit text-muted me-2"></i>
                        <span class="text-muted">
                            更新于 <time datetime="{{ content.updated_at.isoformat() }}">
                                {{ moment(content.updated_at).format('YYYY年MM月DD日') }}
                            </time>
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock text-muted me-2"></i>
                        <span class="text-muted">
                            预计阅读 {{ estimate_reading_time(content.content) }} 分钟
                        </span>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <i class="fas fa-font text-muted me-2"></i>
                        <span class="text-muted">
                            字数统计 {{ count_words(content.content) }} 字
                        </span>
                    </div>
                </div>
                
                <!-- Featured Image -->
                {% if content.featured_image %}
                <div class="mb-4">
                    <img src="{{ url_for('static', filename='uploads/' + content.featured_image) }}" 
                         class="img-fluid rounded shadow" alt="{{ content.title }}"
                         style="width: 100%; height: 400px; object-fit: cover;">
                </div>
                {% endif %}
                
                <!-- Tags -->
                {% if content.tags %}
                <div class="mb-4">
                    <div class="d-flex flex-wrap gap-2">
                        <span class="text-muted me-2">
                            <i class="fas fa-tags"></i> 标签：
                        </span>
                        {% for tag in content.tags %}
                        <a href="{{ url_for('content.tag_content', tag=tag.name) }}" 
                           class="badge bg-light text-primary text-decoration-none">
                            #{{ tag.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </header>
            
            <!-- Table of Contents (if available) -->
            {% set toc = generate_toc(content.content) %}
            {% if toc and toc | length > 2 %}
            <div class="card mb-4 bg-light">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>文章目录
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-of-contents">
                        <ul class="list-unstyled mb-0">
                            {% for item in toc %}
                            <li class="toc-item toc-level-{{ item.level }}" style="margin-left: {{ (item.level - 1) * 20 }}px;">
                                <a href="#{{ item.anchor }}" class="text-decoration-none text-primary">
                                    {{ item.title }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Article Content -->
            <div class="content-body mb-5">
                {{ render_markdown(content.content) | safe }}
            </div>
            
            <!-- Source Attribution (if reposted) -->
            {% if content.source_type == '转载' %}
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>文章来源
                </h6>
                <p class="mb-2">
                    本文转载自：
                    {% if content.source_url %}
                    <a href="{{ content.source_url }}" target="_blank" class="alert-link">
                        {{ content.source_url }}
                    </a>
                    {% else %}
                    其他来源
                    {% endif %}
                </p>
                {% if content.source_author %}
                <p class="mb-0">
                    原作者：<strong>{{ content.source_author }}</strong>
                </p>
                {% endif %}
                <hr>
                <p class="mb-0 small">
                    转载仅供学习交流，版权归原作者所有。如有侵权，请联系删除。
                </p>
            </div>
            {% endif %}
            
            <!-- Share Buttons -->
            <div class="mb-4">
                <h6 class="mb-3">
                    <i class="fas fa-share-alt me-2"></i>分享文章
                </h6>
                <div class="d-flex gap-2">
                    <a href="https://twitter.com/intent/tweet?text={{ content.title }}&url={{ request.url }}" 
                       target="_blank" class="btn btn-outline-info btn-sm">
                        <i class="fab fa-twitter me-1"></i>Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" 
                       target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fab fa-facebook me-1"></i>Facebook
                    </a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url }}" 
                       target="_blank" class="btn btn-outline-dark btn-sm">
                        <i class="fab fa-linkedin me-1"></i>LinkedIn
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" id="copy-link">
                        <i class="fas fa-link me-1"></i>复制链接
                    </button>
                </div>
            </div>
            
            <!-- Navigation to Previous/Next Articles -->
            <nav class="mb-5">
                <div class="row">
                    {% if prev_content %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    <i class="fas fa-chevron-left me-1"></i>上一篇
                                </h6>
                                <h6 class="card-title">
                                    <a href="{{ url_for('content.detail', id=prev_content.id) }}" 
                                       class="text-decoration-none text-dark">
                                        {{ prev_content.title }}
                                    </a>
                                </h6>
                                <p class="card-text small text-muted">
                                    {{ moment(prev_content.created_at).format('YYYY-MM-DD') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if next_content %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    下一篇 <i class="fas fa-chevron-right ms-1"></i>
                                </h6>
                                <h6 class="card-title">
                                    <a href="{{ url_for('content.detail', id=next_content.id) }}" 
                                       class="text-decoration-none text-dark">
                                        {{ next_content.title }}
                                    </a>
                                </h6>
                                <p class="card-text small text-muted">
                                    {{ moment(next_content.created_at).format('YYYY-MM-DD') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </nav>
        </div>
        
        <!-- Sidebar -->
        <aside class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <!-- Author Info -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <img src="{{ url_for('static', filename='img/avatar.jpg') }}" 
                                 class="rounded-circle" width="80" height="80" alt="作者头像"
                                 onerror="this.src='https://via.placeholder.com/80x80/007bff/ffffff?text=Author'">
                        </div>
                        <h6 class="card-title">关于作者</h6>
                        <p class="card-text small text-muted">
                            专注于Web开发和技术分享的全栈开发者，热衷于创造优雅的解决方案。
                        </p>
                        <div class="d-flex justify-content-center gap-2">
                            <a href="https://github.com/yourusername" target="_blank" 
                               class="btn btn-outline-dark btn-sm">
                                <i class="fab fa-github"></i>
                            </a>
                            <a href="https://linkedin.com/in/yourusername" target="_blank" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-linkedin"></i>
                            </a>
                            <a href="mailto:your@email.com" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-envelope"></i>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Related Content -->
                {% if related_content %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-thumbs-up me-2"></i>相关推荐
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for related in related_content %}
                        <div class="d-flex mb-3 {% if not loop.last %}pb-3 border-bottom{% endif %}">
                            <div class="flex-shrink-0 me-3">
                                <span class="badge bg-primary">
                                    {{ get_category_emoji(related.category) }}
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <a href="{{ url_for('content.detail', id=related.id) }}" 
                                       class="text-decoration-none text-dark">
                                        {{ related.title | truncate(40) }}
                                    </a>
                                </h6>
                                <small class="text-muted">
                                    {{ moment(related.created_at).format('MM-DD') }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Popular Tags in This Category -->
                {% if category_tags %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-tags me-2"></i>{{ content.category }}相关标签
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for tag, count in category_tags %}
                        <a href="{{ url_for('content.tag_content', tag=tag) }}" 
                           class="badge bg-light text-primary text-decoration-none me-1 mb-2">
                            #{{ tag }} <span class="text-muted">({{ count }})</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Latest in Same Category -->
                {% if latest_in_category %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>更多{{ content.category }}内容
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for item in latest_in_category %}
                        <div class="d-flex mb-3 {% if not loop.last %}pb-3 border-bottom{% endif %}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <a href="{{ url_for('content.detail', id=item.id) }}" 
                                       class="text-decoration-none text-dark">
                                        {{ item.title | truncate(40) }}
                                    </a>
                                </h6>
                                <small class="text-muted">
                                    {{ moment(item.created_at).fromNow() }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-3">
                            <a href="{{ url_for('content.category_list', category=content.category) }}" 
                               class="btn btn-outline-primary btn-sm">
                                查看全部{{ content.category }}内容
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Contact CTA -->
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-handshake me-2"></i>项目合作
                        </h6>
                        <p class="card-text small text-muted">
                            对文章内容有疑问？需要技术咨询或项目合作？
                        </p>
                        <a href="{{ url_for('main.inquiry_form') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-envelope me-1"></i>联系我
                        </a>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</article>
{% endblock %}

{% block extra_css %}
<style>
.content-body {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #333;
}

.content-body h1,
.content-body h2,
.content-body h3,
.content-body h4,
.content-body h5,
.content-body h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
    color: #212529;
}

.content-body h1 {
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.content-body h2 {
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #dee2e6;
}

.content-body p {
    margin-bottom: 1.2rem;
}

.content-body img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin: 1.5rem 0;
}

.content-body blockquote {
    border-left: 4px solid #007bff;
    background-color: #f8f9fa;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
}

.content-body code {
    background-color: #f1f3f4;
    color: #d63384;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-size: 0.9em;
}

.content-body pre {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    overflow-x: auto;
    position: relative;
    margin: 1.5rem 0;
}

.content-body pre code {
    background: none;
    color: inherit;
    padding: 0;
    border-radius: 0;
}

.content-body ul,
.content-body ol {
    margin-bottom: 1.2rem;
    padding-left: 2rem;
}

.content-body li {
    margin-bottom: 0.5rem;
}

.content-body table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.content-body table th,
.content-body table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.content-body table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.content-body table tr:hover {
    background-color: #f8f9fa;
}

.table-of-contents {
    max-height: 300px;
    overflow-y: auto;
}

.toc-item {
    margin-bottom: 0.5rem;
}

.toc-item a {
    font-size: 0.9rem;
    line-height: 1.4;
}

.toc-item a:hover {
    text-decoration: underline !important;
}

/* Smooth scroll behavior for anchor links */
html {
    scroll-behavior: smooth;
}

/* Highlight target headings */
:target {
    scroll-margin-top: 100px;
}

/* Print styles */
@media print {
    .card,
    aside,
    .btn,
    .badge {
        display: none !important;
    }
    
    .content-body {
        font-size: 12pt;
        line-height: 1.4;
    }
    
    .content-body pre,
    .content-body blockquote {
        break-inside: avoid;
        border: 1px solid #ccc;
    }
}

/* Dark theme adjustments */
[data-bs-theme="dark"] .content-body {
    color: #e9ecef;
}

[data-bs-theme="dark"] .content-body h1,
[data-bs-theme="dark"] .content-body h2,
[data-bs-theme="dark"] .content-body h3,
[data-bs-theme="dark"] .content-body h4,
[data-bs-theme="dark"] .content-body h5,
[data-bs-theme="dark"] .content-body h6 {
    color: #f8f9fa;
}

[data-bs-theme="dark"] .content-body blockquote {
    background-color: #2d3748;
    border-color: #4299e1;
}

[data-bs-theme="dark"] .content-body code {
    background-color: #2d3748;
    color: #f56565;
}

[data-bs-theme="dark"] .content-body pre {
    background-color: #2d3748;
    border-color: #4a5568;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Copy link functionality
document.getElementById('copy-link').addEventListener('click', async function() {
    try {
        await navigator.clipboard.writeText(window.location.href);
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-check me-1"></i>已复制';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('复制失败:', err);
        window.PersonalPortal.showToast('复制链接失败', 'error');
    }
});

// Smooth scrolling for TOC links
document.querySelectorAll('.table-of-contents a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Add reading progress indicator
function addReadingProgress() {
    const article = document.querySelector('.content-body');
    if (!article) return;
    
    const progressBar = document.createElement('div');
    progressBar.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, #007bff, #0dcaf0);
        z-index: 9999;
        transition: width 0.3s ease;
    `;
    document.body.appendChild(progressBar);
    
    window.addEventListener('scroll', () => {
        const articleRect = article.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const articleHeight = article.offsetHeight;
        
        const scrolled = Math.max(0, windowHeight - articleRect.top);
        const progress = Math.min(100, (scrolled / articleHeight) * 100);
        
        progressBar.style.width = progress + '%';
    });
}

// Initialize reading progress
document.addEventListener('DOMContentLoaded', function() {
    addReadingProgress();
});

// Track reading time (optional analytics)
let startTime = Date.now();
let readingTime = 0;

window.addEventListener('beforeunload', function() {
    readingTime = Math.round((Date.now() - startTime) / 1000);
    
    // You can send this data to analytics service
    console.log('Reading time:', readingTime, 'seconds');
});
</script>
{% endblock %}