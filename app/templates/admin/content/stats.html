{% extends "base.html" %}

{% block title %}内容统计分析 - 管理后台{% endblock %}
{% block meta_description %}内容管理统计分析页面，提供内容发布趋势、SEO表现、热门内容等数据分析和可视化图表。{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.stats-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stats-card h5 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.metric-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: center;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #6c757d;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-change {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.metric-change.positive {
    color: #28a745;
}

.metric-change.negative {
    color: #dc3545;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}

.content-table {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.content-table .table {
    margin-bottom: 0;
}

.content-table .table th {
    background: #f8f9fa;
    border: none;
    padding: 1rem;
    font-weight: 600;
    color: #495057;
}

.content-table .table td {
    border: none;
    padding: 1rem;
    vertical-align: middle;
}

.content-table .table tbody tr:hover {
    background-color: #f8f9fa;
}

.category-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.category-item {
    background: #f8f9fa;
    border-radius: 0.75rem;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
}

.category-item:hover {
    background: #e9ecef;
    transform: scale(1.05);
}

.category-count {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.category-name {
    font-size: 0.875rem;
    color: #6c757d;
}

.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.tag-cloud .tag-item {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.tag-cloud .tag-item:hover {
    transform: scale(1.1);
    color: white;
    text-decoration: none;
}

.tag-count {
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.75rem;
}

.seo-distribution {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.seo-item {
    text-align: center;
    padding: 1rem;
    border-radius: 0.75rem;
    color: white;
    font-weight: 600;
}

.seo-item.excellent {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.seo-item.good {
    background: linear-gradient(135deg, #17a2b8, #6f42c1);
}

.seo-item.fair {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.seo-item.poor {
    background: linear-gradient(135deg, #6c757d, #495057);
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
}

.trend-up {
    color: #28a745;
}

.trend-down {
    color: #dc3545;
}

.trend-stable {
    color: #6c757d;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.period-selector {
    background: white;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .stats-header {
        padding: 1.5rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .category-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .seo-distribution {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .export-buttons {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 统计概览 -->
    <div class="stats-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2>内容统计分析</h2>
                <p class="mb-0 opacity-75">全面的内容数据分析和趋势洞察</p>
            </div>
            <div class="export-buttons">
                <button class="btn btn-light btn-sm" onclick="exportStats('pdf')">
                    <i class="bi bi-file-pdf me-2"></i>PDF报告
                </button>
                <button class="btn btn-light btn-sm" onclick="exportStats('excel')">
                    <i class="bi bi-file-excel me-2"></i>Excel表格
                </button>
                <a href="{{ url_for('content_management.content_list') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-2"></i>返回列表
                </a>
            </div>
        </div>
    </div>

    <!-- 时间段选择 -->
    <div class="period-selector">
        <div class="d-flex align-items-center gap-3">
            <span class="fw-semibold">统计周期：</span>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="period" id="week" value="7" checked>
                <label class="btn btn-outline-primary btn-sm" for="week">最近7天</label>

                <input type="radio" class="btn-check" name="period" id="month" value="30">
                <label class="btn btn-outline-primary btn-sm" for="month">最近30天</label>

                <input type="radio" class="btn-check" name="period" id="quarter" value="90">
                <label class="btn btn-outline-primary btn-sm" for="quarter">最近3个月</label>

                <input type="radio" class="btn-check" name="period" id="year" value="365">
                <label class="btn btn-outline-primary btn-sm" for="year">最近1年</label>
            </div>
        </div>
    </div>

    <!-- 核心指标 -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-value text-primary">{{ basic_stats.total }}</div>
                <div class="metric-label">总内容数</div>
                <div class="metric-change positive">
                    <i class="bi bi-arrow-up"></i> +12% 较上月
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-value text-success">{{ basic_stats.published }}</div>
                <div class="metric-label">已发布内容</div>
                <div class="metric-change positive">
                    <i class="bi bi-arrow-up"></i> +8% 较上月
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-value text-warning">{{ basic_stats.draft }}</div>
                <div class="metric-label">草稿内容</div>
                <div class="metric-change negative">
                    <i class="bi bi-arrow-down"></i> -5% 较上月
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-value text-info">{{ basic_stats.featured }}</div>
                <div class="metric-label">精选内容</div>
                <div class="metric-change positive">
                    <i class="bi bi-arrow-up"></i> +15% 较上月
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 分类统计 -->
        <div class="col-lg-6">
            <div class="stats-card">
                <h5><i class="bi bi-pie-chart me-2"></i>分类分布</h5>
                <div class="category-stats">
                    {% for category, count in category_stats.items() %}
                    <div class="category-item">
                        <div class="category-count">{{ count }}</div>
                        <div class="category-name">{{ category }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 月度趋势 -->
        <div class="col-lg-6">
            <div class="stats-card">
                <h5><i class="bi bi-graph-up me-2"></i>发布趋势</h5>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 热门内容 -->
        <div class="col-lg-8">
            <div class="stats-card">
                <h5><i class="bi bi-fire me-2"></i>热门内容 TOP 10</h5>
                <div class="content-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>分类</th>
                                <th>浏览量</th>
                                <th>发布时间</th>
                                <th>SEO评分</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for content in popular_content %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('content_management.edit_content', id=content.id) }}" 
                                       class="text-decoration-none fw-semibold">
                                        {{ content.title | truncate(40) }}
                                    </a>
                                    {% if content.is_featured %}
                                    <i class="bi bi-star-fill text-warning ms-2"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ content.category }}</span>
                                </td>
                                <td>
                                    <div class="trend-indicator">
                                        <span class="fw-bold">{{ content.view_count or 0 }}</span>
                                        <i class="bi bi-eye text-muted"></i>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ content.published_at.strftime('%m-%d') if content.published_at else '-' }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if content.seo_score >= 80 else 'bg-warning' if content.seo_score >= 60 else 'bg-secondary' }}">
                                        {{ content.seo_score or 0 }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEO评分分布 -->
        <div class="col-lg-4">
            <div class="stats-card">
                <h5><i class="bi bi-search me-2"></i>SEO评分分布</h5>
                <div class="seo-distribution">
                    {% for score_range, count in seo_distribution %}
                    {% set range_class = 'excellent' if '80+' in score_range else 'good' if '60-79' in score_range else 'fair' if '40-59' in score_range else 'poor' %}
                    <div class="seo-item {{ range_class }}">
                        <div style="font-size: 1.5rem; font-weight: bold;">{{ count }}</div>
                        <div style="font-size: 0.875rem;">{{ score_range }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 标签云 -->
            <div class="stats-card">
                <h5><i class="bi bi-tags me-2"></i>热门标签</h5>
                <div class="tag-cloud">
                    {% for tag in tag_stats %}
                    <a href="{{ url_for('content_management.content_list', search=tag.name) }}" 
                       class="tag-item">
                        {{ tag.name }}
                        <span class="tag-count">{{ tag.usage_count }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 详细分析 -->
    <div class="row">
        <div class="col-12">
            <div class="stats-card">
                <h5><i class="bi bi-clipboard-data me-2"></i>详细数据分析</h5>
                
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center p-3">
                            <div class="h4 text-primary">{{ "%.1f"|format((basic_stats.published / basic_stats.total * 100) if basic_stats.total > 0 else 0) }}%</div>
                            <div class="text-muted">发布率</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center p-3">
                            <div class="h4 text-success">
                                {{ (popular_content[0].view_count if popular_content else 0) // basic_stats.published if basic_stats.published > 0 else 0 }}
                            </div>
                            <div class="text-muted">平均浏览量</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center p-3">
                            <div class="h4 text-warning">
                                {% set total_score = 0 %}
                                {% set score_count = 0 %}
                                {% for score_range, count in seo_distribution %}
                                    {% if '80+' in score_range %}
                                        {% set total_score = total_score + (90 * count) %}
                                        {% set score_count = score_count + count %}
                                    {% elif '60-79' in score_range %}
                                        {% set total_score = total_score + (70 * count) %}
                                        {% set score_count = score_count + count %}
                                    {% elif '40-59' in score_range %}
                                        {% set total_score = total_score + (50 * count) %}
                                        {% set score_count = score_count + count %}
                                    {% else %}
                                        {% set total_score = total_score + (30 * count) %}
                                        {% set score_count = score_count + count %}
                                    {% endif %}
                                {% endfor %}
                                {{ "%.0f"|format(total_score / score_count if score_count > 0 else 0) }}
                            </div>
                            <div class="text-muted">平均SEO评分</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center p-3">
                            <div class="h4 text-info">{{ tag_stats | length }}</div>
                            <div class="text-muted">标签总数</div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">数据更新时间</h6>
                        <small class="text-muted">2025-09-10 12:54:00</small>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise me-2"></i>刷新数据
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="generateReport()">
                            <i class="bi bi-file-text me-2"></i>生成报告
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    initCategoryChart();
    initTrendChart();
    
    // 绑定时间段选择器
    document.querySelectorAll('input[name="period"]').forEach(radio => {
        radio.addEventListener('change', function() {
            refreshDataByPeriod(this.value);
        });
    });
});

// 分类分布饼图
function initCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for category, count in category_stats.items() %}
                '{{ category }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for category, count in category_stats.items() %}
                    {{ count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// 发布趋势图
function initTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: [
                {% for month, count in monthly_stats %}
                '{{ month }}',
                {% endfor %}
            ],
            datasets: [{
                label: '发布数量',
                data: [
                    {% for month, count in monthly_stats %}
                    {{ count }},
                    {% endfor %}
                ],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });
}

// 按时间段刷新数据
function refreshDataByPeriod(days) {
    // 这里可以通过AJAX获取指定时间段的数据
    console.log('Refreshing data for', days, 'days');
    
    // 显示加载状态
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    `;
    overlay.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div>正在加载数据...</div>
        </div>
    `;
    document.body.appendChild(overlay);
    
    // 模拟API调用
    setTimeout(() => {
        document.body.removeChild(overlay);
        // 这里更新图表和数据
    }, 1500);
}

// 刷新统计数据
function refreshStats() {
    location.reload();
}

// 生成报告
function generateReport() {
    const reportData = {
        basic_stats: {{ basic_stats | tojson }},
        category_stats: {{ category_stats | tojson }},
        seo_distribution: [
            {% for score_range, count in seo_distribution %}
            {"range": "{{ score_range }}", "count": {{ count }}},
            {% endfor %}
        ],
        popular_content_count: {{ popular_content | length }},
        tag_count: {{ tag_stats | length }}
    };

    // 创建报告内容
    const reportHtml = `
        <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #667eea;">内容统计报告</h1>
                <p style="color: #6c757d;">生成时间：${new Date().toLocaleString()}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div style="text-align: center; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: #007bff;">${reportData.basic_stats.total}</div>
                    <div style="color: #6c757d;">总内容数</div>
                </div>
                <div style="text-align: center; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${reportData.basic_stats.published}</div>
                    <div style="color: #6c757d;">已发布</div>
                </div>
                <div style="text-align: center; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">${reportData.basic_stats.draft}</div>
                    <div style="color: #6c757d;">草稿</div>
                </div>
                <div style="text-align: center; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: #17a2b8;">${reportData.basic_stats.featured}</div>
                    <div style="color: #6c757d;">精选</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #495057;">分类分布</h3>
                ${Object.entries(reportData.category_stats).map(([category, count]) => 
                    `<div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f8f9fa;">
                        <span>${category}</span>
                        <span style="font-weight: bold;">${count}</span>
                    </div>`
                ).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; color: #6c757d;">
                <p>本报告由内容管理系统自动生成</p>
            </div>
        </div>
    `;

    // 创建新窗口显示报告
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>内容统计报告</title>
            <style>
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="text-align: center; padding: 20px; background: #f8f9fa;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">打印报告</button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">关闭</button>
            </div>
            ${reportHtml}
        </body>
        </html>
    `);
    reportWindow.document.close();
}

// 导出统计数据
function exportStats(format) {
    const data = {
        format: format,
        basic_stats: {{ basic_stats | tojson }},
        category_stats: {{ category_stats | tojson }},
        monthly_stats: [
            {% for month, count in monthly_stats %}
            {"month": "{{ month }}", "count": {{ count }}},
            {% endfor %}
        ]
    };

    if (format === 'pdf') {
        generateReport(); // 使用现有的报告生成功能
    } else if (format === 'excel') {
        // 创建CSV数据（简化的Excel格式）
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "指标,数值\n";
        csvContent += "总内容数," + data.basic_stats.total + "\n";
        csvContent += "已发布," + data.basic_stats.published + "\n";
        csvContent += "草稿," + data.basic_stats.draft + "\n";
        csvContent += "精选," + data.basic_stats.featured + "\n\n";
        
        csvContent += "分类,数量\n";
        Object.entries(data.category_stats).forEach(([category, count]) => {
            csvContent += category + "," + count + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "content_stats_" + new Date().toISOString().slice(0,10) + ".csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// 实时时钟更新
setInterval(function() {
    const now = new Date();
    const timeElements = document.querySelectorAll('[data-update-time]');
    timeElements.forEach(el => {
        el.textContent = now.toLocaleString();
    });
}, 1000);

// 数据刷新提醒
let dataAge = 0;
setInterval(function() {
    dataAge++;
    if (dataAge > 300) { // 5分钟
        const refreshBtn = document.querySelector('[onclick="refreshStats()"]');
        if (refreshBtn) {
            refreshBtn.classList.add('btn-warning');
            refreshBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>数据较旧，建议刷新';
        }
    }
}, 1000);
</script>
{% endblock %}