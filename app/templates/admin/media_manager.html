{% extends "base.html" %}

{% block title %}åª’ä½“ç®¡ç†å™¨ - ç®¡ç†åå°{% endblock %}
{% block meta_description %}ä¸ªäººé—¨æˆ·ç½‘ç«™åª’ä½“æ–‡ä»¶ç®¡ç†ç•Œé¢ï¼Œæ–‡ä»¶æ•´ç†ã€å­˜å‚¨åˆ†æå’Œä¼˜åŒ–å·¥å…·ã€‚{% endblock %}

{% block extra_css %}
<style>
.media-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem 1rem 0 0;
    padding: 2rem;
    margin: -1rem -1rem 1rem -1rem;
}

.stats-grid {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    text-align: center;
    padding: 1rem;
    border-radius: 0.5rem;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--bs-secondary);
    font-size: 0.875rem;
}

.folder-tree {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.folder-item {
    padding: 0.5rem;
    border-left: 3px solid var(--bs-primary);
    margin: 0.25rem 0;
    background-color: var(--bs-light);
    border-radius: 0 0.25rem 0.25rem 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.folder-item:hover {
    background-color: var(--bs-primary);
    color: white;
}

.file-item {
    padding: 0.3rem 0.5rem;
    border-left: 2px solid var(--bs-success);
    margin: 0.15rem 0 0.15rem 1rem;
    background-color: rgba(25, 135, 84, 0.1);
    border-radius: 0 0.25rem 0.25rem 0;
    font-size: 0.875rem;
}

.storage-progress {
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    background-color: var(--bs-light);
    margin: 1rem 0;
}

.progress-bar {
    height: 100%;
    transition: width 0.3s ease;
}

.tools-section {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.tool-card {
    border: 1px solid var(--bs-gray-200);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.tool-card:hover {
    border-color: var(--bs-primary);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.search-section {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.file-type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    margin: 0.1rem;
}

/* Dark theme adjustments */
[data-bs-theme="dark"] .stat-card,
[data-bs-theme="dark"] .folder-tree,
[data-bs-theme="dark"] .tools-section,
[data-bs-theme="dark"] .search-section {
    background-color: var(--bs-dark);
    border-color: var(--bs-gray-700);
}

[data-bs-theme="dark"] .tool-card {
    background-color: var(--bs-gray-800);
    border-color: var(--bs-gray-600);
}

[data-bs-theme="dark"] .stats-grid {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
}

@media (max-width: 768px) {
    .media-header {
        padding: 1.5rem;
        margin: -0.5rem -0.5rem 1rem -0.5rem;
    }
    
    .stats-grid, .folder-tree, .tools-section, .search-section {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card">
        <div class="media-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">ğŸ“‚ åª’ä½“ç®¡ç†å™¨</h1>
                    <p class="mb-0 opacity-90">æ–‡ä»¶ç®¡ç†ã€å­˜å‚¨åˆ†æå’Œä¼˜åŒ–å·¥å…·</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light" onclick="refreshStats()">
                        <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°ç»Ÿè®¡
                    </button>
                    <button class="btn btn-outline-light" onclick="exportReport()">
                        <i class="fas fa-download me-2"></i>å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body">
            <!-- Storage Statistics -->
            <div class="stats-grid">
                <div class="row">
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-primary">{{ stats.total_size_mb | round(1) }}</div>
                            <div class="stat-label">æ€»å­˜å‚¨ (MB)</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-info">{{ stats.total_files }}</div>
                            <div class="stat-label">æ–‡ä»¶æ€»æ•°</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-warning">{{ stats.large_files | length }}</div>
                            <div class="stat-label">å¤§æ–‡ä»¶ (>10MB)</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-danger">{{ stats.old_files | length }}</div>
                            <div class="stat-label">æ—§æ–‡ä»¶ (>30å¤©)</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-success">{{ stats.storage_usage_percent }}%</div>
                            <div class="stat-label">å­˜å‚¨ä½¿ç”¨ç‡</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card">
                            <div class="stat-value text-secondary">{{ stats.file_types | length }}</div>
                            <div class="stat-label">æ–‡ä»¶ç±»å‹</div>
                        </div>
                    </div>
                </div>
                
                <!-- Storage Progress Bar -->
                <div class="storage-progress">
                    <div class="progress-bar" 
                         style="width: {{ stats.storage_usage_percent }}%; 
                                background-color: {% if stats.storage_usage_percent > 80 %}var(--bs-danger){% elif stats.storage_usage_percent > 60 %}var(--bs-warning){% else %}var(--bs-success){% endif %};">
                    </div>
                </div>
                <small class="text-muted">å­˜å‚¨ä½¿ç”¨: {{ stats.total_size_mb | round(1) }} MB / 1000 MB</small>
            </div>

            <div class="row">
                <!-- Folder Structure -->
                <div class="col-lg-6">
                    <div class="folder-tree">
                        <h5 class="mb-3">
                            <i class="fas fa-folder-tree me-2"></i>æ–‡ä»¶å¤¹ç»“æ„
                        </h5>
                        
                        {% for folder_path, folder_data in folder_structure.items() %}
                        <div class="folder-item" onclick="toggleFolder('{{ folder_path }}')">
                            <i class="fas fa-folder me-2"></i>
                            {{ folder_path if folder_path != '/' else 'æ ¹ç›®å½•' }}
                            <span class="badge bg-primary ms-2">{{ folder_data.count }} æ–‡ä»¶</span>
                            <span class="badge bg-success ms-1">{{ folder_data.size | round(1) }} MB</span>
                        </div>
                        
                        <div id="folder-{{ folder_path }}" class="folder-contents" style="display: none;">
                            {% for file_info in folder_data.files[:5] %}
                            <div class="file-item">
                                <i class="fas {% if file_info.is_image %}fa-image{% else %}fa-file{% endif %} me-2"></i>
                                {{ file_info.name }}
                                <span class="badge bg-light text-dark ms-2">{{ file_info.size_mb }} MB</span>
                                {% if file_info.is_image %}
                                <span class="file-type-badge bg-info">å›¾ç‰‡</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% if folder_data.files | length > 5 %}
                            <div class="file-item text-muted">
                                ... è¿˜æœ‰ {{ folder_data.files | length - 5 }} ä¸ªæ–‡ä»¶
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Management Tools -->
                <div class="col-lg-6">
                    <div class="tools-section">
                        <h5 class="mb-3">
                            <i class="fas fa-tools me-2"></i>ç®¡ç†å·¥å…·
                        </h5>

                        <!-- File Organization -->
                        <div class="tool-card">
                            <h6 class="fw-bold">ğŸ“ æ–‡ä»¶æ•´ç†</h6>
                            <p class="text-muted small mb-3">æŒ‰ç±»å‹å’Œæ—¥æœŸè‡ªåŠ¨æ•´ç†æ•£ä¹±æ–‡ä»¶</p>
                            <button class="btn btn-outline-primary" onclick="organizeFiles()">
                                <i class="fas fa-magic me-2"></i>å¼€å§‹æ•´ç†
                            </button>
                        </div>

                        <!-- Cleanup Old Files -->
                        <div class="tool-card">
                            <h6 class="fw-bold">ğŸ—‘ï¸ æ¸…ç†æ—§æ–‡ä»¶</h6>
                            <p class="text-muted small mb-3">åˆ é™¤è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—§æ–‡ä»¶</p>
                            <div class="d-flex gap-2 align-items-center mb-2">
                                <input type="number" class="form-control form-control-sm" id="cleanupDays" value="30" min="1" max="365" style="width: 80px;">
                                <span class="text-muted small">å¤©å‰çš„æ–‡ä»¶</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-warning btn-sm" onclick="cleanupFiles(true)">
                                    <i class="fas fa-eye me-1"></i>é¢„è§ˆ
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="cleanupFiles(false)">
                                    <i class="fas fa-trash me-1"></i>æ¸…ç†
                                </button>
                            </div>
                        </div>

                        <!-- Image Optimization -->
                        <div class="tool-card">
                            <h6 class="fw-bold">ğŸ¨ å›¾ç‰‡ä¼˜åŒ–</h6>
                            <p class="text-muted small mb-3">æ‰¹é‡å‹ç¼©å’Œä¼˜åŒ–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶</p>
                            <button class="btn btn-outline-success" onclick="optimizeImages()">
                                <i class="fas fa-compress me-2"></i>å¼€å§‹ä¼˜åŒ–
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <h5 class="mb-3">
                    <i class="fas fa-search me-2"></i>æ–‡ä»¶æœç´¢
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group mb-3">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchQuery" 
                                   placeholder="æœç´¢æ–‡ä»¶å...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select mb-3" id="searchType">
                            <option value="">æ‰€æœ‰ç±»å‹</option>
                            <option value="images">å›¾ç‰‡æ–‡ä»¶</option>
                            <option value="documents">æ–‡æ¡£æ–‡ä»¶</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchFiles()">
                            æœç´¢
                        </button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" style="display: none;">
                    <h6 class="mt-4 mb-3">æœç´¢ç»“æœ</h6>
                    <div id="searchResultsList"></div>
                </div>
            </div>

            <!-- File Types Distribution -->
            {% if stats.file_types %}
            <div class="mt-4">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>æ–‡ä»¶ç±»å‹åˆ†å¸ƒ
                </h5>
                <div class="row">
                    {% for ext, type_stats in stats.file_types.items() %}
                    <div class="col-md-3 col-sm-6 mb-2">
                        <div class="d-flex align-items-center">
                            <span class="file-type-badge {% if ext in ['.jpg', '.jpeg', '.png', '.gif', '.webp'] %}bg-info{% elif ext in ['.pdf', '.doc', '.docx', '.txt'] %}bg-success{% elif ext in ['.zip', '.rar', '.7z'] %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ ext if ext != 'no_extension' else 'æ— æ‰©å±•å' }}
                            </span>
                            <span class="ms-2 text-muted small">
                                {{ type_stats.count }} ä¸ªæ–‡ä»¶ ({{ type_stats.size_mb | round(1) }} MB)
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Large Files Alert -->
            {% if stats.large_files %}
            <div class="alert alert-warning mt-4">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>å¤§æ–‡ä»¶æé†’</h6>
                <p class="mb-2">å‘ç° {{ stats.large_files | length }} ä¸ªå¤§äº 10MB çš„æ–‡ä»¶ï¼š</p>
                <ul class="mb-0">
                    {% for file in stats.large_files[:3] %}
                    <li>{{ file.name }} - {{ file.size_mb }} MB</li>
                    {% endfor %}
                    {% if stats.large_files | length > 3 %}
                    <li class="text-muted">... è¿˜æœ‰ {{ stats.large_files | length - 3 }} ä¸ªå¤§æ–‡ä»¶</li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Refresh statistics
function refreshStats() {
    const btn = document.querySelector('button[onclick="refreshStats()"]');
    const icon = btn.querySelector('i');
    
    icon.classList.add('fa-spin');
    btn.disabled = true;
    
    setTimeout(() => {
        location.reload();
    }, 500);
}

// Toggle folder contents
function toggleFolder(folderPath) {
    const contents = document.getElementById(`folder-${folderPath}`);
    if (contents) {
        contents.style.display = contents.style.display === 'none' ? 'block' : 'none';
    }
}

// Organize files
function organizeFiles() {
    if (confirm('ç¡®å®šè¦å¼€å§‹æ•´ç†æ–‡ä»¶å—ï¼Ÿè¿™å°†ç§»åŠ¨æ•£ä¹±çš„æ–‡ä»¶åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­ã€‚')) {
        showLoading('æ­£åœ¨æ•´ç†æ–‡ä»¶...');
        
        fetch('/admin/media/organize', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                alert(data.message);
                refreshStats();
            } else {
                alert('æ•´ç†å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('æ•´ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
}

// Cleanup old files
function cleanupFiles(dryRun) {
    const days = document.getElementById('cleanupDays').value;
    const action = dryRun ? 'é¢„è§ˆæ¸…ç†' : 'æ¸…ç†';
    
    if (confirm(`ç¡®å®šè¦${action}è¶…è¿‡ ${days} å¤©çš„æ–‡ä»¶å—ï¼Ÿ`)) {
        showLoading(dryRun ? 'æ­£åœ¨åˆ†ææ–‡ä»¶...' : 'æ­£åœ¨æ¸…ç†æ–‡ä»¶...');
        
        const formData = new FormData();
        formData.append('days', days);
        formData.append('dry_run', dryRun);
        
        fetch('/admin/media/cleanup', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                if (dryRun) {
                    showCleanupPreview(data.files, data.size_saved_mb);
                } else {
                    alert(`æ¸…ç†å®Œæˆï¼æ¸…ç†äº† ${data.cleaned_count} ä¸ªæ–‡ä»¶ï¼ŒèŠ‚çœäº† ${data.size_saved_mb} MB`);
                    refreshStats();
                }
            } else {
                alert('æ¸…ç†å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('æ¸…ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
}

// Optimize images
function optimizeImages() {
    if (confirm('ç¡®å®šè¦å¼€å§‹ä¼˜åŒ–æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
        showLoading('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡...');
        
        fetch('/admin/media/optimize', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                alert(data.message);
                refreshStats();
            } else {
                alert('ä¼˜åŒ–å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
}

// Search files
function searchFiles() {
    const query = document.getElementById('searchQuery').value;
    const type = document.getElementById('searchType').value;
    
    if (!query.trim()) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
    }
    
    const params = new URLSearchParams();
    params.append('query', query);
    if (type) params.append('type', type);
    
    fetch('/admin/media/search?' + params)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results, data.count);
            } else {
                alert('æœç´¢å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
}

// Display search results
function displaySearchResults(results, count) {
    const resultsDiv = document.getElementById('searchResults');
    const listDiv = document.getElementById('searchResultsList');
    
    if (count === 0) {
        listDiv.innerHTML = '<p class="text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶</p>';
    } else {
        let html = `<p class="text-info">æ‰¾åˆ° ${count} ä¸ªæ–‡ä»¶ï¼š</p>`;
        html += '<div class="list-group">';
        
        results.forEach(file => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${file.is_image ? 'fa-image' : 'fa-file'} me-2"></i>
                            <strong>${file.name}</strong>
                            <small class="text-muted ms-2">${file.folder}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">${file.size_mb} MB</span>
                            <small class="text-muted d-block">${file.modified_at}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        listDiv.innerHTML = html;
    }
    
    resultsDiv.style.display = 'block';
}

// Show cleanup preview
function showCleanupPreview(files, sizeSaved) {
    let html = `<div class="alert alert-info">`;
    html += `<h6>æ¸…ç†é¢„è§ˆ</h6>`;
    html += `<p>å°†æ¸…ç† ${files.length} ä¸ªæ–‡ä»¶ï¼ŒèŠ‚çœ ${sizeSaved} MB å­˜å‚¨ç©ºé—´ï¼š</p>`;
    html += `<ul class="mb-0">`;
    
    files.slice(0, 10).forEach(file => {
        html += `<li>${file.name} - ${file.size_mb} MB (${file.days_old} å¤©å‰)</li>`;
    });
    
    if (files.length > 10) {
        html += `<li class="text-muted">... è¿˜æœ‰ ${files.length - 10} ä¸ªæ–‡ä»¶</li>`;
    }
    
    html += `</ul></div>`;
    
    const resultsDiv = document.getElementById('searchResults');
    const listDiv = document.getElementById('searchResultsList');
    listDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// Export report
function exportReport() {
    // Generate a simple report
    const stats = {
        totalSize: {{ stats.total_size_mb | round(1) }},
        totalFiles: {{ stats.total_files }},
        largeFiles: {{ stats.large_files | length }},
        oldFiles: {{ stats.old_files | length }},
        storageUsage: {{ stats.storage_usage_percent }}
    };
    
    const report = `åª’ä½“å­˜å‚¨æŠ¥å‘Š\nç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n\n` +
                  `æ€»å­˜å‚¨: ${stats.totalSize} MB\n` +
                  `æ–‡ä»¶æ€»æ•°: ${stats.totalFiles}\n` +
                  `å¤§æ–‡ä»¶æ•°: ${stats.largeFiles}\n` +
                  `æ—§æ–‡ä»¶æ•°: ${stats.oldFiles}\n` +
                  `å­˜å‚¨ä½¿ç”¨ç‡: ${stats.storageUsage}%\n`;
    
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `media-report-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Loading utilities
function showLoading(message) {
    // Simple loading implementation
    document.body.style.cursor = 'wait';
    console.log(message);
}

function hideLoading() {
    document.body.style.cursor = 'default';
}

// Search on Enter key
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchFiles();
    }
});
</script>
{% endblock %}